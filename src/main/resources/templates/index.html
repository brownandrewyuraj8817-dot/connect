<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Customer CRM - Firebase</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- TailwindCDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Scrollbar nh·∫π nh√†ng */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5f5;
            border-radius: 999px;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-50 flex flex-col">
<!-- Top bar -->
<header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-20">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
            <div class="h-8 w-8 rounded-xl bg-gradient-to-tr from-violet-500 to-cyan-400 flex items-center justify-center text-xs font-bold">
                CRM
            </div>
            <div>
                <h1 class="text-lg font-semibold">Customer Console</h1>
                <p class="text-xs text-slate-400">Spring Boot + Firebase Firestore</p>
            </div>
        </div>
        <span id="statusBadge" class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-300">
        ƒêang k·∫øt n·ªëi API...
      </span>
    </div>
</header>

<!-- Main layout -->
<main class="flex-1">
    <div class="max-w-5xl mx-auto px-4 py-6 grid lg:grid-cols-[1.2fr,2fr] gap-6">
        <!-- Left: Form -->
        <section class="bg-slate-900/70 border border-slate-800 rounded-2xl p-5 shadow-lg shadow-slate-950/40">
            <div class="flex items-center justify-between mb 4">
                <h2 class="text-base font-semibold flex items-center gap-2">
                    <span id="formModeLabel">Th√™m kh√°ch h√†ng</span>
                    <span id="editBadge" class="hidden text-[10px] px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-300 border border-amber-400/40">
              ƒêang ch·ªânh s·ª≠a
            </span>
                </h2>
                <button id="resetFormBtn"
                        class="text-xs px-2 py-1 rounded-full border border-slate-700 text-slate-300 hover:bg-slate-800">
                    L√†m m·ªõi form
                </button>
            </div>

            <form id="customerForm" class="space-y-4 mt-2">
                <input type="hidden" id="customerId" />

                <div>
                    <label class="block text-xs font-medium text-slate-300 mb-1">H·ªç t√™n</label>
                    <input id="nameInput" type="text" required
                           class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500" />
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-300 mb-1">Email</label>
                    <input id="emailInput" type="email" required
                           class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500" />
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-slate-300 mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input id="phoneInput" type="text"
                               class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500" />
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-300 mb-1">ƒê·ªãa ch·ªâ</label>
                        <input id="addressInput" type="text"
                               class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500" />
                    </div>
                </div>

                <div class="flex items-center justify-between pt-2">
                    <p class="text-[11px] text-slate-500">
                        * D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o Firestore qua API Spring Boot.
                    </p>
                    <button type="submit"
                            class="inline-flex items-center gap-2 rounded-xl bg-violet-500 hover:bg-violet-400 px-4 py-2 text-xs font-medium text-slate-950 shadow shadow-violet-500/40">
                        <span id="submitLabel">Th√™m m·ªõi</span>
                    </button>
                </div>
            </form>
        </section>

        <!-- Right: List & search -->
        <section class="bg-slate-900/70 border border-slate-800 rounded-2xl p-5 shadow-lg shadow-slate-950/40 flex flex-col">
            <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-3">
                <div class="flex-1">
                    <label class="block text-xs font-medium text-slate-300 mb-1">T√¨m ki·∫øm</label>
                    <div class="relative">
                        <input id="searchInput" type="text" placeholder="T√¨m theo t√™n ho·∫∑c email..."
                               class="w-full rounded-xl bg-slate-900 border border-slate-700 pl-8 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" />
                        <span class="absolute left-2 top-1.5 text-slate-500 text-xs">üîç</span>
                    </div>
                </div>
                <div class="flex items-end gap-2">
                    <button id="refreshBtn"
                            class="text-xs px-3 py-2 rounded-xl border border-slate-700 text-slate-200 hover:bg-slate-800">
                        Refresh
                    </button>
                </div>
            </div>

            <div class="flex items-center justify-between mb-2">
                <p id="countLabel" class="text-xs text-slate-400">
                    ƒêang t·∫£i d·ªØ li·ªáu...
                </p>
                <p class="text-[11px] text-slate-500">
                    CRUD client-side, g·ªçi API REST.
                </p>
            </div>

            <div class="relative flex-1 min-h-[260px]">
                <div class="absolute inset-0 overflow-auto rounded-xl border border-slate-800/80 bg-slate-950/40">
                    <table class="min-w-full text-xs">
                        <thead class="bg-slate-900/80 sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-2 text-left font-medium text-slate-300">T√™n</th>
                            <th class="px-3 py-2 text-left font-medium text-slate-300">Email</th>
                            <th class="px-3 py-2 text-left font-medium text-slate-300 hidden md:table-cell">SƒêT</th>
                            <th class="px-3 py-2 text-left font-medium text-slate-300 hidden lg:table-cell">ƒê·ªãa ch·ªâ</th>
                            <th class="px-3 py-2 text-right font-medium text-slate-300">H√†nh ƒë·ªông</th>
                        </tr>
                        </thead>
                        <tbody id="customerTableBody" class="divide-y divide-slate-800/80">
                        <!-- Rows render b·∫±ng JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
</main>

<!-- Toast -->
<div id="toast"
     class="fixed bottom-4 right-4 px-4 py-2 rounded-xl text-xs bg-slate-900 border border-slate-700 text-slate-100 shadow-lg shadow-slate-950/40 opacity-0 pointer-events-none transition-opacity">
</div>

<script>
    const API_BASE = "http://localhost:8080/api/customers"; // ch·ªânh l·∫°i n·∫øu deploy

    let customers = [];
    let isEditing = false;

    const statusBadge = document.getElementById("statusBadge");
    const customerForm = document.getElementById("customerForm");
    const customerIdInput = document.getElementById("customerId");
    const nameInput = document.getElementById("nameInput");
    const emailInput = document.getElementById("emailInput");
    const phoneInput = document.getElementById("phoneInput");
    const addressInput = document.getElementById("addressInput");
    const submitLabel = document.getElementById("submitLabel");
    const formModeLabel = document.getElementById("formModeLabel");
    const editBadge = document.getElementById("editBadge");
    const searchInput = document.getElementById("searchInput");
    const refreshBtn = document.getElementById("refreshBtn");
    const resetFormBtn = document.getElementById("resetFormBtn");
    const customerTableBody = document.getElementById("customerTableBody");
    const countLabel = document.getElementById("countLabel");
    const toast = document.getElementById("toast");

    function showToast(message, type = "info") {
        toast.textContent = message;
        toast.className =
            "fixed bottom-4 right-4 px-4 py-2 rounded-xl text-xs shadow-lg shadow-slate-950/40 opacity-0 pointer-events-none transition-opacity " +
            (type === "error"
                ? "bg-red-900/80 border border-red-500/60 text-red-50"
                : "bg-slate-900/90 border border-slate-600 text-slate-50");
        requestAnimationFrame(() => {
            toast.classList.remove("opacity-0");
            toast.classList.add("opacity-100");
            toast.style.pointerEvents = "auto";
            setTimeout(() => {
                toast.classList.remove("opacity-100");
                toast.classList.add("opacity-0");
                toast.style.pointerEvents = "none";
            }, 2500);
        });
    }

    function setStatus(text, ok = true) {
        statusBadge.textContent = text;
        statusBadge.className =
            "text-xs px-3 py-1 rounded-full border " +
            (ok
                ? "bg-emerald-900/40 border-emerald-500/60 text-emerald-200"
                : "bg-red-900/40 border-red-500/60 text-red-200");
    }

    function setFormMode(editing) {
        isEditing = editing;
        if (editing) {
            formModeLabel.textContent = "Ch·ªânh s·ª≠a kh√°ch h√†ng";
            submitLabel.textContent = "C·∫≠p nh·∫≠t";
            editBadge.classList.remove("hidden");
        } else {
            formModeLabel.textContent = "Th√™m kh√°ch h√†ng";
            submitLabel.textContent = "Th√™m m·ªõi";
            editBadge.classList.add("hidden");
            customerIdInput.value = "";
            customerForm.reset();
        }
    }

    function renderTable() {
        const keyword = searchInput.value.trim().toLowerCase();
        const filtered = customers.filter((c) => {
            if (!keyword) return true;
            return (
                (c.name && c.name.toLowerCase().includes(keyword)) ||
                (c.email && c.email.toLowerCase().includes(keyword))
            );
        });

        countLabel.textContent =
            filtered.length === 0
                ? "Kh√¥ng c√≥ kh√°ch h√†ng n√†o."
                : `Hi·ªÉn th·ªã ${filtered.length} / ${customers.length} kh√°ch h√†ng`;

        customerTableBody.innerHTML = "";

        if (filtered.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML =
                '<td colspan="5" class="px-3 py-6 text-center text-slate-500 text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu ho·∫∑c kh√¥ng kh·ªõp t·ª´ kh√≥a t√¨m ki·∫øm.</td>';
            customerTableBody.appendChild(tr);
            return;
        }

        filtered.forEach((c) => {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-900/60";

            tr.innerHTML = `
          <td class="px-3 py-2 align-top">
            <div class="font-medium text-xs">${c.name || "-"}</div>
            <div class="text-[10px] text-slate-500">${c.id || ""}</div>
          </td>
          <td class="px-3 py-2 align-top">
            <div class="text-xs">${c.email || "-"}</div>
          </td>
          <td class="px-3 py-2 align-top hidden md:table-cell">
            <div class="text-xs">${c.phone || "-"}</div>
          </td>
          <td class="px-3 py-2 align-top hidden lg:table-cell">
            <div class="text-xs line-clamp-2">${c.address || "-"}</div>
          </td>
          <td class="px-3 py-2 align-top">
            <div class="flex items-center justify-end gap-2">
              <button class="text-[11px] px-2 py-1 rounded-lg border border-slate-600 text-slate-200 hover:bg-slate-800"
                      data-action="edit" data-id="${c.id}">
                S·ª≠a
              </button>
              <button class="text-[11px] px-2 py-1 rounded-lg border border-red-500/60 text-red-200 hover:bg-red-900/50"
                      data-action="delete" data-id="${c.id}">
                X√≥a
              </button>
            </div>
          </td>
        `;
            customerTableBody.appendChild(tr);
        });
    }

    async function fetchCustomers() {
        try {
            setStatus("ƒêang t·∫£i d·ªØ li·ªáu...", true);
            const res = await fetch(API_BASE);
            if (!res.ok) throw new Error("HTTP " + res.status);
            customers = await res.json();
            renderTable();
            setStatus("ƒê√£ k·∫øt n·ªëi API", true);
        } catch (err) {
            console.error(err);
            setStatus("L·ªói k·∫øt n·ªëi API", false);
            showToast("Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch kh√°ch h√†ng.", "error");
        }
    }

    async function createCustomer(data) {
        const res = await fetch(API_BASE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
    }

    async function updateCustomer(id, data) {
        const res = await fetch(`${API_BASE}/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
    }

    async function deleteCustomer(id) {
        const res = await fetch(`${API_BASE}/${id}`, {
            method: "DELETE",
        });
        if (!res.ok && res.status !== 204) throw new Error("HTTP " + res.status);
        return true;
    }

    customerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const payload = {
            id: customerIdInput.value || null,
            name: nameInput.value.trim(),
            email: emailInput.value.trim(),
            phone: phoneInput.value.trim(),
            address: addressInput.value.trim(),
        };

        try {
            if (isEditing && payload.id) {
                await updateCustomer(payload.id, payload);
                showToast("C·∫≠p nh·∫≠t kh√°ch h√†ng th√†nh c√¥ng!");
            } else {
                await createCustomer(payload);
                showToast("Th√™m kh√°ch h√†ng th√†nh c√¥ng!");
            }
            setFormMode(false);
            await fetchCustomers();
        } catch (err) {
            console.error(err);
            showToast("L·ªói khi l∆∞u kh√°ch h√†ng.", "error");
        }
    });

    resetFormBtn.addEventListener("click", () => {
        setFormMode(false);
    });

    refreshBtn.addEventListener("click", () => {
        fetchCustomers();
    });

    searchInput.addEventListener("input", () => {
        renderTable();
    });

    customerTableBody.addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;

        const action = btn.dataset.action;
        const id = btn.dataset.id;
        const customer = customers.find((c) => c.id === id);
        if (!customer) return;

        if (action === "edit") {
            customerIdInput.value = customer.id || "";
            nameInput.value = customer.name || "";
            emailInput.value = customer.email || "";
            phoneInput.value = customer.phone || "";
            addressInput.value = customer.address || "";
            setFormMode(true);
            window.scrollTo({ top: 0, behavior: "smooth" });
        } else if (action === "delete") {
            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng n√†y?")) return;
            try {
                await deleteCustomer(id);
                showToast("ƒê√£ x√≥a kh√°ch h√†ng.");
                await fetchCustomers();
            } catch (err) {
                console.error(err);
                showToast("L·ªói khi x√≥a kh√°ch h√†ng.", "error");
            }
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        setFormMode(false);
        fetchCustomers();
    });
</script>
</body>
</html>
